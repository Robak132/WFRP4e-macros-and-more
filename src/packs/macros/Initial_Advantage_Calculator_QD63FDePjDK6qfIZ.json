{
  "_id": "QD63FDePjDK6qfIZ",
  "author": "MJAZjdKh3QKREKG2",
  "command": "/* ==========\n* MACRO: Initial Advantage Calculator\n* AUTHOR: Robak132\n* DESCRIPTION: Calculate initial advantage and applies it to actors.\n========== */\n\nasync function update(character, newAdvantage) {\n  return await character.actor.update({\n    \"system.status.advantage.value\": newAdvantage\n  });\n}\n\nasync function submit(html) {\n  const advantage = $(html)\n    .find(\"select\")\n    .map((_, e) => {\n      return {\n        players: e.options[e.options.selectedIndex].dataset.players ?? 0,\n        enemy: e.options[e.options.selectedIndex].dataset.enemies ?? 0\n      };\n    })\n    .get();\n  const playersAdvantage = advantage.reduce((acc, x) => acc + Number(x.players), 0);\n  const enemiesAdvantage = advantage.reduce((acc, x) => acc + Number(x.enemy), 0);\n\n  if (game.combat !== null) {\n    const enemy = game.combat.combatants.find((combatant) => combatant.token.disposition === -1);\n    console.log(enemy);\n    await update(enemy, enemiesAdvantage);\n\n    const players = game.combat.combatants.find((combatant) => combatant.token.disposition === 1);\n    console.log(players);\n    await update(players, playersAdvantage);\n  }\n\n  const chatMsgContent = `\n\t\t<h1>Initial Advantage</h1>\n\t\t<p><b>Players:</b> ${playersAdvantage}</p>\n\t\t<p><b>Enemies:</b> ${enemiesAdvantage}</p>`;\n  ChatMessage.create(\n    {\n      content: chatMsgContent,\n      whisper: game.users.filter((u) => u.isGM).map((u) => u.id)\n    },\n    false\n  );\n}\n\nnew Dialog({\n  title: \"Initial Advantage\",\n  content: `<form>\n  <div class=\"form-group\">\n    <p style=\"flex: 1\" title=\"One side possessing an advantage in movement such as being mounted or facing giant spiders in trees.\" class=\"section-title\">Manoeuvrability</p>\n    <select style=\"flex: 2\">\n      <option data-enemies=\"2\">Mobile Enemies</option>\n      <option selected>Static forces</option>\n      <option data-players=\"2\">Mobile Players</option>\n    </select>\n  </div>\n  <div class=\"form-group\">\n    <p style=\"flex: 1\" class=\"section-title\">Surprise</p>\n    <select style=\"flex: 2\">\n      <option data-players=\"2\">Surprised Enemies</option>\n      <option selected>No surprise</option>\n      <option data-enemies=\"2\">Surprised Players</option>\n    </select>\n  </div>\n  <div class=\"form-group\">\n    <p style=\"flex: 1\" class=\"section-title\">Outnumbering</p>\n    <select style=\"flex: 2\">\n      <option data-enemies=\"3\">Enemies outnumber Players (3:1)</option>\n      <option data-enemies=\"2\">Enemies outnumber Players (2:1)</option>\n      <option data-enemies=\"1\">Enemies outnumber Players</option>\n      <option selected>Equal forces</option>\n      <option data-players=\"1\">Players outnumber Enemies</option>\n      <option data-players=\"2\">Players outnumber Enemies (2:1)</option>\n      <option data-players=\"3\">Players outnumber Enemies (3:1)</option>\n    </select>\n  </div>\n  <div class=\"form-group\">\n    <p style=\"flex: 1\" title=\"Light cover: an advantageous position, such as a hill.\\nHeavy cover: key position as a bridge.\" class=\"section-title\">Terrain</p>\n    <select style=\"flex: 2\">\n      <option data-players=\"2\">Heavy cover (Players)</option>\n      <option data-players=\"1\">Light cover (Players)</option>\n      <option selected>Equal</option>\n      <option data-enemies=\"1\">Light cover (Enemies)</option>\n      <option data-enemies=\"2\">Heavy cover (Enemies)</option>\n    </select>\n  </div>\n  <div class=\"form-group\">\n    <p style=\"flex: 1\" title=\"Dangerous threat: dangerous threat such as a warpfire thrower, Ogre, or Troll.\\nVery dangerous threat: a match for several foes such as an organ gun, Manticore, or Griffon.\\nExtremely dangerous threat: a match for a dozen lesser foes such as a Dragon or Greater Daemon.\" class=\"section-title\">Threat</p>\n    <select style=\"flex: 2\">\n      <option data-players=\"3\">Extremely Dangerous (Players)</option>\n      <option data-players=\"2\">Very Dangerous (Players)</option>\n      <option data-players=\"1\">Dangerous (Players)</option>\n      <option selected>None</option>\n      <option data-enemies=\"1\">Dangerous (Enemies)</option>\n      <option data-enemies=\"2\">Very Dangerous (Enemies)</option>\n      <option data-enemies=\"3\">Extremely Dangerous (Enemies)</option>\n    </select>\n  </div>\n</form>`,\n  buttons: {\n    yes: {\n      icon: \"<i class='fas fa-check'></i>\",\n      label: game.i18n.localize(\"Apply\"),\n      callback: async (html) => await submit(html)\n    },\n    no: {\n      icon: \"<i class='fas fa-times'></i>\",\n      label: game.i18n.localize(\"Cancel\")\n    }\n  },\n  default: \"yes\"\n}).render(true);\n",
  "flags": {
    "wfrp4e-macros-and-more": {
      "version": "1.0.0",
      "sourceId": "QD63FDePjDK6qfIZ"
    }
  },
  "folder": null,
  "img": "modules/wfrp4e-macros-and-more/assets/icons/initial-advantage-calculator.svg",
  "name": "Initial Advantage Calculator",
  "scope": "global",
  "type": "script",
  "_key": "!macros!QD63FDePjDK6qfIZ"
}
